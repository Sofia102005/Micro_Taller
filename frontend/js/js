const URL_BASE_API = "http://127.0.0.1:8000/api/pepito";

const cargarEstudiantes = async (parametrosBusqueda = {}) => {
    try {
        const urlEstudiantes = new URL(`${URL_BASE_API}/estudiantes`);
        
        Object.entries(parametrosBusqueda).forEach(([clave, valor]) => {
            if (valor) {
                urlEstudiantes.searchParams.append(clave, valor);
            }
        });

        const respuesta = await fetch(urlEstudiantes);
        if (!respuesta.ok) throw new Error('Error en la respuesta de la red');

        const datos = await respuesta.json();
        const cuerpoTabla = document.querySelector("#estudiantes tbody");
        cuerpoTabla.innerHTML = "";  

        datos.data.forEach((estudiante) => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${estudiante.cod}</td>
                <td>${estudiante.nombres}</td>
                <td>${estudiante.email}</td>
                <td>${estudiante.nota_definitiva}</td>
                <td>${estudiante.estado}</td>
                <td>
                    <button class="eliminar-btn" data-codigo="${estudiante.cod}">Eliminar</button>
                </td>
            `;
            cuerpoTabla.appendChild(fila);
        });

        const resumenElemento = document.getElementById("resumen");
        resumenElemento.innerHTML = `
            <p>Aprobados: ${datos.resumen.aprobados}</p>
            <p>Reprobados: ${datos.resumen.reprobados}</p>
            <p>Sin notas: ${datos.resumen.sin_notas}</p>
        `;
        
        agregarEventosEliminar();
    } catch (error) {
        console.error("Error al cargar los estudiantes:", error);
    }
};

const eliminarEstudiante = async (codigoEstudiante) => {
    if (confirm("¿Estás seguro de que deseas eliminar a este estudiante?")) {
        try {
            const respuesta = await fetch(`${URL_BASE_API}/estudiante/${codigoEstudiante}`, {
                method: "DELETE",
            });
            const datos = await respuesta.json();
            alert(datos.msg);
            cargarEstudiantes();
        } catch (error) {
            console.error("Error al eliminar el estudiante:", error);
        }
    }
};

const agregarEventosEliminar = () => {
    const botonesEliminar = document.querySelectorAll('.eliminar-btn');
    botonesEliminar.forEach(boton => {
        boton.addEventListener('click', () => {
            const codigoEstudiante = boton.getAttribute('data-codigo');
            eliminarEstudiante(codigoEstudiante);
        });
    });
};

const validarNota = (nota) => {
    return nota >= 0 && nota <= 5;
};

const agregarEstudiante = (button) => {
    const row = button.closest('tr');
    const nota1 = parseFloat(row.querySelector('input[name="nota1"]').value);
    const nota2 = parseFloat(row.querySelector('input[name="nota2"]').value);
    const nota3 = parseFloat(row.querySelector('input[name="nota3"]').value);
    const nota4 = parseFloat(row.querySelector('input[name="nota4"]').value);

    if (![nota1, nota2, nota3, nota4].every(validarNota)) {
        alert("Las notas deben estar entre 0 y 5.");
        return;
    }

    const promedio = (nota1 + nota2 + nota3 + nota4) / 4;
    row.querySelector('.promedio').textContent = promedio.toFixed(2);
};

document.getElementById('filtros').addEventListener('submit', (evento) => {
    evento.preventDefault();

    const parametrosBusqueda = {
        codigo: document.getElementById('codigo').value,
        nombre: document.getElementById('nombre').value,
        email: document.getElementById('email').value,
        estado: document.getElementById('estado').value,
        rango_min: document.getElementById('rango_min') ? document.getElementById('rango_min').value : undefined,
        rango_max: document.getElementById('rango_max') ? document.getElementById('rango_max').value : undefined,
        sin_notas: document.getElementById('sin_notas').checked ? 1 : 0,
    };

    cargarEstudiantes(parametrosBusqueda);
});

cargarEstudiantes();