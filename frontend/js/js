const URL_BASE_API = "http://127.0.0.1:8000/api/estudiantes"; // Cambiado a la URL correcta

const cargarEstudiantes = async (parametrosBusqueda = {}) => {
    try {
        const urlEstudiantes = new URL(URL_BASE_API);
        
        Object.entries(parametrosBusqueda).forEach(([clave, valor]) => {
            if (valor) {
                urlEstudiantes.searchParams.append(clave, valor);
            }
        });

        const respuesta = await fetch(urlEstudiantes);
        if (!respuesta.ok) throw new Error('Error en la respuesta de la red');

        const datos = await respuesta.json();
        const cuerpoTabla = document.querySelector("#estudiantes tbody");
        cuerpoTabla.innerHTML = "";  

        datos.data.forEach((estudiante) => {
            const fila = document.createElement("tr");
            fila.innerHTML = `
                <td>${estudiante.cod}</td>
                <td>${estudiante.nombres}</td>
                <td>${estudiante.email}</td>
                <td>${estudiante.nota_definitiva || 'N/A'}</td>
                <td>${estudiante.estado || 'Sin notas'}</td>
                <td>
                    <button class="eliminar-btn" data-codigo="${estudiante.cod}">Eliminar</button>
                </td>
            `;
            cuerpoTabla.appendChild(fila);
        });

        const resumenElemento = document.getElementById("resumen");
        resumenElemento.innerHTML = `
            <p>Aprobados: ${datos.resumen.aprobados}</p>
            <p>Reprobados: ${datos.resumen.reprobados}</p>
            <p>Sin notas: ${datos.resumen.sin_notas}</p>
        `;
        
        agregarEventosEliminar();
    } catch (error) {
        console.error("Error al cargar los estudiantes:", error);
    }
};

const eliminarEstudiante = async (codigoEstudiante) => {
    if (confirm("¿Estás seguro de que deseas eliminar a este estudiante?")) {
        try {
            const respuesta = await fetch(`${URL_BASE_API}/${codigoEstudiante}`, {
                method: "DELETE",
            });
            const datos = await respuesta.json();
            alert(datos.msg);
            cargarEstudiantes(); // Recargar la lista de estudiantes después de eliminar
        } catch (error) {
            console.error("Error al eliminar el estudiante:", error);
        }
    }
};

const agregarEventosEliminar = () => {
    const botonesEliminar = document.querySelectorAll('.eliminar-btn');
    botonesEliminar.forEach(boton => {
        boton.addEventListener('click', () => {
            const codigoEstudiante = boton.getAttribute('data-codigo');
            eliminarEstudiante(codigoEstudiante);
        });
    });
};

const validarNota = (nota) => {
    return nota >= 0 && nota <= 5;
};

const agregarEstudiante = async (button) => {
    const row = button.closest('tr');
    const codigo = row.querySelector('input[name="codigo_estudiante"]').value;
    const nombre = row.querySelector('input[name="nombre_estudiante"]').value;
    const email = row.querySelector('input[name="email_estudiante"]').value;
    const nota1 = parseFloat(row.querySelector('input[name="nota1"]').value) || 0;
    const nota2 = parseFloat(row.querySelector('input[name="nota2"]').value) || 0;
    const nota3 = parseFloat(row.querySelector('input[name="nota3"]').value) || 0;
    const nota4 = parseFloat(row.querySelector('input[name="nota4"]').value) || 0;

    // Validar las notas
    if (![nota1, nota2, nota3, nota4].every(validarNota)) {
        alert("Las notas deben estar entre 0 y 5.");
        return;
    }

    const promedio = (nota1 + nota2 + nota3 + nota4) / 4;
    row.querySelector('.promedio').textContent = promedio.toFixed(2);

    // Determinar el estado basado en el promedio
    let estado;
    if (promedio >= 3) {
        estado = "Aprobado";
    } else {
        estado = "Reprobado";
    }
    row.querySelector('.estado').textContent = estado;

    // Enviar datos al servidor
    const data = {
        cod: codigo,
        nombres: nombre,
        email: email,
        nota_definitiva: promedio,
        estado: estado
    };

    try {
        const respuesta = await fetch(URL_BASE_API, {
            method: 'POST',
            headers: {
                'Content-Type : 'application/json',
            },
            body: JSON.stringify(data),
        });

        if (!respuesta.ok) throw new Error('Error al agregar el estudiante');

        const respuestaDatos = await respuesta.json();
        alert('Estudiante agregado exitosamente');
        cargarEstudiantes(); // Recargar la lista de estudiantes
    } catch (error) {
        console.error("Error al agregar el estudiante:", error);
        alert('Error al agregar estudiante');
    }
};

document.getElementById('filtros').addEventListener('submit', (evento) => {
    evento.preventDefault();

    const parametrosBusqueda = {
        codigo: document.getElementById('codigo').value,
        nombre: document.getElementById('nombre').value,
        email: document.getElementById('email').value,
        estado: document.getElementById('estado') ? document.getElementById('estado').value : '',
        sin_notas: document.getElementById('sin_notas').checked ? 1 : 0,
    };

    cargarEstudiantes(parametrosBusqueda);
});

cargarEstudiantes();